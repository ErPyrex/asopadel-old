{% extends 'base.html' %}
{% block title %}Reservar Cancha{% endblock %}

{% block content %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css' rel='stylesheet' />

<div class="container mt-4">
    <div class="row">
        <!-- Columna Izquierda: Formulario -->
        <div class="col-md-4 mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">游닇 Nueva Reserva</h4>
                </div>
                <div class="card-body">
                    {% if cancha %}
                    <div class="alert alert-info py-2">
                        <small>Reservando en:</small><br>
                        <strong>{{ cancha.nombre }}</strong>
                    </div>
                    {% endif %}

                    <form method="POST" id="reservaForm">
                        {% csrf_token %}

                        <!-- Campo Cancha (Oculto o Select) -->
                        <div class="mb-3">
                            <label class="form-label">Cancha</label>
                            {{ form.cancha }}
                        </div>

                        <!-- Campo Fecha -->
                        <div class="mb-3">
                            <label class="form-label">Fecha</label>
                            {{ form.fecha }}
                        </div>

                        <div class="row">
                            <!-- Hora Inicio -->
                            <div class="col-6 mb-3">
                                <label class="form-label">Inicio</label>
                                {{ form.hora_inicio }}
                            </div>
                            <!-- Hora Fin -->
                            <div class="col-6 mb-3">
                                <label class="form-label">Fin</label>
                                {{ form.hora_fin }}
                            </div>
                        </div>

                        <div class="d-grid mt-3">
                            <button type="submit" class="btn btn-success">Reservar Ahora</button>
                            <a href="{% url 'core:player_reservations' %}" class="btn btn-outline-secondary mt-2">Mis
                                Reservas</a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-3 shadow-sm border-info">
                <div class="card-body">
                    <h6 class="text-info"><i class="bi bi-info-circle"></i> Instrucciones</h6>
                    <small>
                        <ol class="ps-3 mb-0">
                            <li>Selecciona un <strong>espacio vac칤o</strong> en el calendario.</li>
                            <li>Verifica la fecha y horas en el formulario.</li>
                            <li>Haz clic en <strong>Reservar Ahora</strong>.</li>
                        </ol>
                        <hr class="my-2">
                        <span class="badge bg-warning text-dark">Amarillo</span> Pendiente (Otros)<br>
                        <span class="badge bg-danger">Rojo</span> Ocupado<br>
                        <span class="badge bg-success">Verde</span> Mi Reserva
                    </small>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: Calendario -->
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-body p-2">
                    <div id='calendar'></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var canchaSelect = document.getElementById('id_cancha'); // ID por defecto de Django
        var fechaInput = document.getElementById('id_fecha');
        var horaInicioInput = document.getElementById('id_hora_inicio');
        var horaFinInput = document.getElementById('id_hora_fin');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            locale: 'es',
            buttonText: {
                today: 'Hoy',
                month: 'Mes',
                week: 'Semana',
                day: 'D칤a',
                list: 'Lista'
            },
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'timeGridWeek,timeGridDay'
            },
            slotMinTime: '08:00:00', // Horario apertura
            slotMaxTime: '22:00:00', // Horario cierre
            allDaySlot: false,
            expandRows: true,
            height: 'auto',
            navLinks: true, // clic en d칤a va a vista d칤a
            selectable: true,
            selectMirror: true,
            eventTimeFormat: {
                hour: '2-digit',
                minute: '2-digit',
                meridiem: false,
                hour12: false
            },

            // Cargar eventos (reservas existentes)
            events: function (info, successCallback, failureCallback) {
                var canchaId = canchaSelect.value;
                if (!canchaId) return successCallback([]); // Si no hay cancha seleccionada

                // Construir URL din치micamente usando el patr칩n definido en urls.py
                // Usamos un ID dummy '0' para que Django genere la base, y luego lo reemplazamos por el ID real
                var baseUrl = "{% url 'core:api_court_availability' 0 %}";
                var url = baseUrl.replace('/0/', '/' + canchaId + '/') +
                    "?start=" + info.startStr +
                    "&end=" + info.endStr;

                fetch(url)
                    .then(response => response.json())
                    .then(data => successCallback(data))
                    .catch(error => failureCallback(error));
            },

            slotDuration: '02:00:00', // Slots de 2 horas (cuadros visuales)
            slotLabelInterval: '02:00', // Etiquetas cada 2 horas
            snapDuration: '02:00:00', // Forzar selecci칩n en bloques de 2h

            // Al seleccionar un rango vac칤o en el calendario
            select: function (info) {
                fechaInput.value = info.startStr.split('T')[0];

                var start = info.start;
                var end = info.end;

                // Calcular duraci칩n seleccionada manualmente
                var durationHours = (end - start) / (1000 * 60 * 60);

                // Si la selecci칩n es peque침a (ej: clic simple de 30 min), forzar 2 horas por defecto
                // Un partido de p치del dura tipicamente 1.5 - 2 horas
                if (durationHours <= 0.5) {
                    end = new Date(start.getTime() + 2 * 60 * 60 * 1000); // +2 horas

                    // Validar l칤mite de cierre (22:00 seg칰n modelo)
                    var limitHour = 22;
                    if (end.getHours() > limitHour || (end.getHours() === limitHour && end.getMinutes() > 0)) {
                        end.setHours(limitHour, 0, 0); // Capar a las 22:00
                    }
                }

                horaInicioInput.value = start.toTimeString().split(' ')[0].substring(0, 5);
                horaFinInput.value = end.toTimeString().split(' ')[0].substring(0, 5);

                // Efecto visual (opcional)
                horaInicioInput.classList.add('bg-light', 'border-success');
                horaFinInput.classList.add('bg-light', 'border-success');
                setTimeout(() => {
                    horaInicioInput.classList.remove('bg-light', 'border-success');
                    horaFinInput.classList.remove('bg-light', 'border-success');
                }, 500);
            },

            // Re-renderizar si cambia la ventana
            windowResize: function (view) {
                calendar.render();
            }
        });

        calendar.render();

        // Recargar calendario cuando cambie el select de cancha
        if (canchaSelect) {
            canchaSelect.addEventListener('change', function () {
                calendar.refetchEvents();
            });
        }
    });
</script>
{% endblock %}