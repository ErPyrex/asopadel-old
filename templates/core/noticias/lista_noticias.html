{% extends 'base.html' %}
{% load static %}
{% block title %}Gestión de Noticias - Administrador{% endblock %}
{% block content %}
    <div class="container-fluid px-lg-5 py-4">
        <!-- Header de la sección -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-5 gap-3">
            <div>
                <h1 class="display-5 fw-bold mb-2">
                    Gestión de <span class="text-primary">Noticias</span>
                </h1>
                <p class="text-muted fs-5 mb-0">Administra las publicaciones que verán los usuarios.</p>
            </div>
            <div>
                <button class="btn btn-primary btn-lg rounded-pill px-4 fw-bold shadow-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#createNoticiaModal">
                    <i class="ti ti-plus me-2"></i>Nueva Noticia
                </button>
            </div>
        </div>
        <!-- Lista de noticias -->
        <div class="row g-4">
            {% for noticia in noticias %}
                {% with autor_name=noticia.autor.get_full_name|default:noticia.autor.username %}
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 border-0 shadow-sm rounded-4 overflow-hidden ranking-card">
                            {% if noticia.imagen %}
                                <div style="height: 180px; overflow: hidden;">
                                    <img src="{{ noticia.imagen.url }}" class="w-100 h-100" style="object-fit: cover; object-position: {{ noticia.imagen_position }}" alt="{{ noticia.titulo }}">
                                </div>
                            {% else %}
                                <div class="bg-light d-flex align-items-center justify-content-center"
                                     style="height: 180px">
                                    <i class="ti ti-news fs-1 text-muted opacity-25"></i>
                                </div>
                            {% endif %}
                            <div class="card-body p-4 d-flex flex-column">
                                <div class="d-flex align-items-center gap-2 mb-3 text-muted small">
                                    <i class="ti ti-calendar"></i> {{ noticia.fecha_publicacion|date:"d M, Y" }}
                                    <span class="mx-1">•</span>
                                    <i class="ti ti-user"></i> {{ autor_name }}
                                </div>
                                <h5 class="fw-bold mb-3">{{ noticia.titulo }}</h5>
                                <p class="text-muted small mb-4">{{ noticia.cuerpo|truncatewords:20 }}</p>
                                <div class="mt-auto">
                                    <div class="d-flex gap-2 mb-2">
                                        <button class="btn btn-outline-primary btn-sm rounded-pill px-3 fw-bold flex-fill" data-bs-toggle="modal" data-bs-target="#editNoticiaModal{{ noticia.id }}">
                                            <i class="ti ti-edit me-1"></i>Editar
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm rounded-pill px-3 fw-bold flex-fill" data-bs-toggle="modal" data-bs-target="#deleteNoticiaModal{{ noticia.id }}">
                                            <i class="ti ti-trash me-1"></i>Eliminar
                                        </button>
                                    </div>
                                    <button class="btn btn-light btn-sm rounded-pill px-3 fw-bold w-100" data-bs-toggle="modal" data-bs-target="#previewModal{{ noticia.id }}">
                                        <i class="ti ti-eye me-1"></i>Vista previa
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Modal Editar Noticia -->
                    <div class="modal fade" id="editNoticiaModal{{ noticia.id }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                                <div class="modal-header bg-primary py-3">
                                    <h5 class="modal-title fw-bold text-white"><i class="ti ti-edit me-2"></i>Editar Noticia</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body p-4">
                                    <form action="{% url 'core:admin_edit_noticia' noticia.id %}" method="POST" enctype="multipart/form-data" id="editNoticiaForm{{ noticia.id }}">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <label class="form-label fw-bold text-muted small text-uppercase mb-1">Título</label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-light border-end-0"><i class="ti ti-type"></i></span>
                                                <input type="text" name="titulo" class="form-control bg-light border-start-0" value="{{ noticia.titulo }}" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold text-muted small text-uppercase mb-1">Contenido</label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-light border-end-0 align-items-start pt-2"><i class="ti ti-align-left"></i></span>
                                                <textarea name="cuerpo" rows="6" class="form-control bg-light border-start-0" required>{{ noticia.cuerpo }}</textarea>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold text-muted small text-uppercase mb-1">Imagen</label>
                                            <input type="hidden" name="imagen_pos_x" id="edit-pos-x-{{ noticia.id }}" value="{{ noticia.imagen_pos_x }}">
                                            <input type="hidden" name="imagen_pos_y" id="edit-pos-y-{{ noticia.id }}" value="{{ noticia.imagen_pos_y }}">
                                            <div class="image-crop-edit-container" id="crop-container-{{ noticia.id }}">
                                                {% if noticia.imagen %}
                                                <!-- Si ya tiene imagen, mostrar el cropper directamente -->
                                                <div class="image-crop-zone">
                                                    <div class="crop-header d-flex justify-content-between align-items-center mb-2">
                                                        <span class="small text-muted"><i class="ti ti-hand-grab me-1"></i>Arrastra para enmarcar</span>
                                                        <label class="btn btn-sm btn-outline-secondary rounded-pill px-3 mb-0" style="cursor: pointer;">
                                                            <i class="ti ti-refresh me-1"></i>Cambiar
                                                            <input type="file" name="imagen" id="edit-file-{{ noticia.id }}" accept="image/*" class="d-none" onchange="handleEditImageChange(this, {{ noticia.id }})">
                                                        </label>
                                                    </div>
                                                    <div class="crop-viewport" id="viewport-{{ noticia.id }}">
                                                        <div class="crop-frame" id="frame-{{ noticia.id }}">
                                                            <img id="edit-preview-{{ noticia.id }}" src="{{ noticia.imagen.url }}" alt="Vista previa" draggable="false">
                                                        </div>
                                                    </div>
                                                    <div class="crop-hint text-center mt-2">
                                                        <small class="text-muted">Esta es la parte visible de la imagen</small>
                                                    </div>
                                                </div>
                                                {% else %}
                                                <!-- Si no tiene imagen, mostrar dropzone -->
                                                <div class="image-drop-zone" id="dropzone-{{ noticia.id }}" onclick="document.getElementById('edit-file-{{ noticia.id }}').click()">
                                                    <input type="file" name="imagen" id="edit-file-{{ noticia.id }}" accept="image/*" class="d-none" onchange="handleEditImageChange(this, {{ noticia.id }})">
                                                    <div class="text-center p-4">
                                                        <i class="ti ti-cloud-upload fs-1 text-primary mb-2"></i>
                                                        <p class="fw-bold mb-1">Arrastra una imagen aquí</p>
                                                        <p class="text-muted small mb-0">o haz clic para seleccionar</p>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="d-grid gap-2 mt-4">
                                            <button type="submit" class="btn btn-primary rounded-pill fw-bold py-2"><i class="ti ti-device-floppy me-2"></i>Guardar Cambios</button>
                                            <button type="button" class="btn btn-light rounded-pill fw-bold text-muted" data-bs-dismiss="modal">Cancelar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Modal Vista Previa (Simulando Frontend) -->
                    <div class="modal fade"
                         id="previewModal{{ noticia.id }}"
                         tabindex="-1"
                         aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                                <div class="modal-header border-0 pb-0 position-absolute top-0 end-0 z-3">
                                    <button type="button"
                                            class="btn-close btn-close-white bg-dark rounded-circle p-2 opacity-75"
                                            data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body p-0 text-start">
                                    {% if noticia.imagen %}
                                        <div class="position-relative">
                                            <img src="{{ noticia.imagen.url }}"
                                                 class="w-100"
                                                 alt="{{ noticia.titulo }}"
                                                 style="height: 400px;
                                                        object-fit: cover">
                                            <div class="modal-hero-overlay-admin"></div>
                                        </div>
                                    {% endif %}
                                    <div class="p-4 p-md-5">
                                        <div class="d-flex align-items-center gap-3 mb-4 text-muted small">
                                            <span class="badge bg-primary-subtle text-primary border border-primary-subtle rounded-pill px-3 py-2">
                                                <i class="ti ti-calendar me-1"></i>{{ noticia.fecha_publicacion|date:"d M, Y" }}
                                            </span>
                                            <span>•</span>
                                            <span><i class="ti ti-user-circle fs-5 me-1"></i>Por {{ autor_name }}</span>
                                        </div>
                                        <h2 class="display-6 fw-bold mb-4">{{ noticia.titulo }}</h2>
                                        <div class="fs-5 lh-lg text-secondary">{{ noticia.cuerpo|linebreaks }}</div>
                                    </div>
                                </div>
                                <div class="modal-footer bg-light border-0 p-4">
                                    <button type="button"
                                            class="btn btn-secondary rounded-pill px-4"
                                            data-bs-dismiss="modal">
                                        Cerrar
                                        Vista Previa
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Modal Eliminar Noticia -->
                    <div class="modal fade"
                         id="deleteNoticiaModal{{ noticia.id }}"
                         tabindex="-1"
                         aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-0 shadow-lg rounded-4">
                                <div class="modal-body p-5 text-center">
                                    <div class="icon-box mb-4 mx-auto d-flex align-items-center justify-content-center bg-danger-subtle text-danger rounded-circle"
                                         style="width: 80px;
                                                height: 80px">
                                        <i class="ti ti-alert-triangle fs-1"></i>
                                    </div>
                                    <h3 class="fw-bold mb-3">¿Eliminar noticia?</h3>
                                    <p class="text-muted mb-4 fs-5">
                                        Esta acción no se puede deshacer. Se eliminará permanentemente
                                        la noticia:
                                        <br>
                                        <strong>"{{ noticia.titulo }}"</strong>
                                    </p>
                                    <form action="{% url 'core:admin_delete_noticia' noticia.id %}"
                                          method="POST">
                                        {% csrf_token %}
                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-danger btn-lg rounded-pill fw-bold">
                                                Sí,
                                                eliminar
                                            </button>
                                            <button type="button"
                                                    class="btn btn-light btn-lg rounded-pill fw-bold border"
                                                    data-bs-dismiss="modal">No, cancelar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endwith %}
            {% empty %}
                <div class="col-12 text-center py-5">
                    <div class="p-5 bg-light rounded-5">
                        <i class="ti ti-news-off fs-1 text-muted mb-3 d-block"></i>
                        <h3 class="fw-bold">No hay noticias publicadas</h3>
                        <p class="text-muted">Comienza publicando tu primera noticia para informar a la comunidad.</p>
                        <button class="btn btn-primary rounded-pill px-4 fw-bold mt-2"
                                data-bs-toggle="modal"
                                data-bs-target="#createNoticiaModal">Crear primera noticia</button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% include 'core/noticias/modals/modal_crear.html' %}
    <style>
    .image-drop-zone {
        border: 2px dashed var(--color-border);
        border-radius: 16px;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .image-drop-zone:hover {
        border-color: var(--color-primary);
        background-color: rgba(13, 110, 253, 0.05);
    }

    .image-drop-zone.has-image {
        border-style: solid;
        border-color: var(--color-primary);
    }

    .image-preview-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000;
        z-index: 5;
    }

    .image-preview-overlay img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .modern-form .input-group-text {
        border-radius: 12px 0 0 12px;
        color: var(--color-primary);
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
    }

    .modern-form .form-control {
        border-radius: 0 12px 12px 0;
        padding: 0.75rem 1rem;
        border: 1px solid #dee2e6;
    }

    .modern-form .form-control:focus {
        border-color: var(--color-primary);
        box-shadow: none;
        background-color: #fff;
    }

    .modern-form textarea.form-control {
        border-radius: 0 12px 12px 12px;
    }

    /* Estilos para el Hero del Preview */
    .modal-hero-overlay-admin {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 100px;
        background: linear-gradient(transparent, #fff);
    }

    .dark-mode .modal-hero-overlay-admin {
        background: linear-gradient(transparent, #1a1d21);
    }
    </style>
    <script>
    function previewImageModal(input, previewId, overlayId) {
        const preview = document.getElementById(previewId);
        const overlay = document.getElementById(overlayId);
        const dropZone = input.closest('.image-drop-zone');

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.src = e.target.result;
                overlay.classList.remove('d-none');
                dropZone.classList.add('has-image');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Lógica para Drag and Drop en los modales
    document.querySelectorAll('.image-drop-zone').forEach(zone => {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            zone.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        zone.addEventListener('dragover', () => zone.classList.add('border-primary'), false);
        zone.addEventListener('dragleave', () => zone.classList.remove('border-primary'), false);

        zone.addEventListener('drop', e => {
            const input = zone.querySelector('input[type="file"]');
            input.files = e.dataTransfer.files;
            previewImageModal(input, zone.querySelector('img').id, zone.querySelector('.image-preview-overlay').id);
        }, false);
    });

    // ===== CROPPER PARA EDICIÓN =====
    function handleEditImageChange(input, noticiaId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('edit-preview-' + noticiaId);
                preview.src = e.target.result;
                preview.onload = function() {
                    initCropper(noticiaId);
                };
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function initCropper(noticiaId) {
        const frame = document.getElementById('frame-' + noticiaId);
        const preview = document.getElementById('edit-preview-' + noticiaId);
        const posXInput = document.getElementById('edit-pos-x-' + noticiaId);
        const posYInput = document.getElementById('edit-pos-y-' + noticiaId);
        
        if (!frame || !preview) return;

        const frameWidth = frame.offsetWidth;
        const frameHeight = frame.offsetHeight;
        
        // Escalar imagen para cubrir el frame
        const imgRatio = preview.naturalWidth / preview.naturalHeight;
        const frameRatio = frameWidth / frameHeight;
        
        let imgWidth, imgHeight;
        if (imgRatio > frameRatio) {
            imgHeight = frameHeight;
            imgWidth = imgHeight * imgRatio;
        } else {
            imgWidth = frameWidth;
            imgHeight = imgWidth / imgRatio;
        }
        
        preview.style.width = imgWidth + 'px';
        preview.style.height = imgHeight + 'px';
        
        // Posicionar según valores guardados
        const savedPctX = parseInt(posXInput.value) || 50;
        const savedPctY = parseInt(posYInput.value) || 50;
        
        let imgX = -(savedPctX / 100 * imgWidth - frameWidth / 2);
        let imgY = -(savedPctY / 100 * imgHeight - frameHeight / 2);
        
        // Limitar posición
        const minX = frameWidth - imgWidth;
        const minY = frameHeight - imgHeight;
        imgX = Math.max(minX, Math.min(0, imgX));
        imgY = Math.max(minY, Math.min(0, imgY));
        
        preview.style.left = imgX + 'px';
        preview.style.top = imgY + 'px';

        // Drag functionality
        let isDragging = false;
        let startX, startY, currentImgX = imgX, currentImgY = imgY;

        frame.onmousedown = function(e) {
            isDragging = true;
            startX = e.clientX - currentImgX;
            startY = e.clientY - currentImgY;
            e.preventDefault();
        };

        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            
            let newX = e.clientX - startX;
            let newY = e.clientY - startY;
            
            newX = Math.max(minX, Math.min(0, newX));
            newY = Math.max(minY, Math.min(0, newY));
            
            currentImgX = newX;
            currentImgY = newY;
            preview.style.left = newX + 'px';
            preview.style.top = newY + 'px';
            
            // Actualizar valores de posición
            const centerX = -newX + frameWidth / 2;
            const centerY = -newY + frameHeight / 2;
            posXInput.value = Math.max(0, Math.min(100, Math.round((centerX / imgWidth) * 100)));
            posYInput.value = Math.max(0, Math.min(100, Math.round((centerY / imgHeight) * 100)));
        });

        document.addEventListener('mouseup', function() {
            isDragging = false;
        });
    }

    // Inicializar croppers cuando se abren los modales
    document.querySelectorAll('[id^="editNoticiaModal"]').forEach(modal => {
        modal.addEventListener('shown.bs.modal', function() {
            const noticiaId = this.id.replace('editNoticiaModal', '');
            const preview = document.getElementById('edit-preview-' + noticiaId);
            if (preview && preview.src) {
                if (preview.complete) {
                    initCropper(noticiaId);
                } else {
                    preview.onload = function() {
                        initCropper(noticiaId);
                    };
                }
            }
        });
    });
    </script>
    <style>
    .image-crop-zone {
        border: 1px solid var(--bs-gray-300);
        border-radius: 12px;
        padding: 12px;
        background: var(--bs-gray-100);
    }
    .crop-viewport {
        position: relative;
        width: 100%;
        height: 180px;
        overflow: hidden;
        border-radius: 8px;
        background: #000;
    }
    .crop-frame {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        cursor: grab;
    }
    .crop-frame:active {
        cursor: grabbing;
    }
    .crop-frame img {
        position: absolute;
        max-width: none;
        user-select: none;
        -webkit-user-drag: none;
    }
    .image-drop-zone {
        border: 2px dashed var(--bs-gray-300);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--bs-gray-100);
    }
    .image-drop-zone:hover {
        border-color: var(--bs-primary);
        background: rgba(59, 130, 246, 0.05);
    }
    </style>
{% endblock %}

