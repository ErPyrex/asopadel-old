{% load static %}
<!-- Modal Crear Noticia (Shared) -->
<div class="modal fade" id="createNoticiaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <!-- Header con Gradiente Sutil -->
            <div class="modal-header bg-primary py-3 border-0">
                <h5 class="modal-title fw-bold text-white d-flex align-items-center">
                    <div class="bg-white bg-opacity-25 rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                        <i class="ti ti-plus fs-5"></i>
                    </div>
                    Nueva Noticia
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body p-4 p-md-5 bg-card">
                <form action="{% url 'core:admin_create_noticia' %}" method="POST" enctype="multipart/form-data" id="noticiaFormModal">
                    {% csrf_token %}
                    
                    <!-- Campo Título -->
                    <div class="mb-4">
                        <label class="form-label fw-bold text-muted small text-uppercase mb-2">Título de la Noticia</label>
                        <div class="input-group modern-input-group">
                            <span class="input-group-text border-0 ps-3 bg-transparent"><i class="ti ti-typography text-primary"></i></span>
                            <input type="text" name="titulo" class="form-control border-0 py-2 bg-transparent" placeholder="Escriba un título impactante..." required>
                        </div>
                    </div>
                    
                    <!-- Campo Contenido -->
                    <div class="mb-4">
                        <label class="form-label fw-bold text-muted small text-uppercase mb-2">Contenido</label>
                        <div class="input-group modern-input-group align-items-start pt-1">
                            <span class="input-group-text border-0 ps-3 bg-transparent mt-2"><i class="ti ti-align-left text-primary"></i></span>
                            <textarea name="cuerpo" class="form-control border-0 py-2 bg-transparent" rows="5" placeholder="Cuente los detalles de la noticia..." required></textarea>
                        </div>
                    </div>
                    
                    <!-- Zona de Imagen / Cropper -->
                    <div class="mb-4">
                        <label class="form-label fw-bold text-muted small text-uppercase mb-2">Imagen de Portada</label>
                        <input type="hidden" id="news-pos-x-modal" name="imagen_pos_x" value="50">
                        <input type="hidden" id="news-pos-y-modal" name="imagen_pos_y" value="50">
                        
                        <div class="image-crop-container">
                            <!-- Zona de Drop -->
                            <div id="news-drop-zone-modal" class="news-drop-zone-modern" onclick="document.getElementById('news-file-input-modal').click()">
                                <input type="file" id="news-file-input-modal" name="imagen" accept="image/*" class="d-none">
                                <div class="upload-placeholder text-center p-5">
                                    <div class="upload-icon-wrapper mb-3">
                                        <i class="ti ti-cloud-upload fs-1 text-primary"></i>
                                    </div>
                                    <h6 class="fw-bold mb-1">Cargar Imagen</h6>
                                    <p class="text-muted small mb-0">Arrastre aquí o haga clic para seleccionar</p>
                                </div>
                            </div>
                            
                            <!-- Zona de Recorte -->
                            <div id="news-crop-zone-modal" class="news-crop-zone-modern d-none">
                                <div class="crop-header d-flex justify-content-between align-items-center mb-3">
                                    <span class="small text-muted fw-medium"><i class="ti ti-hand-grab me-2"></i>Arrastra para ajustar el encuadre</span>
                                    <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill px-3 py-1 fw-bold" onclick="resetNewsImageModal()">
                                        <i class="ti ti-refresh me-1"></i>Cambiar
                                    </button>
                                </div>
                                <div class="news-crop-viewport-modern shadow-sm">
                                    <div class="news-crop-frame" id="news-crop-frame-modal">
                                        <img id="news-preview-modal" src="" alt="Vista previa" draggable="false">
                                    </div>
                                </div>
                                <div class="text-center mt-3">
                                    <span class="badge bg-light text-muted fw-normal rounded-pill px-3 py-2 border">Vista previa de la posición focal</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de Acción -->
                    <div class="d-grid gap-3 mt-5">
                        <button type="submit" class="btn btn-primary btn-lg rounded-pill fw-bold py-3 shadow-sm hover-lift">
                            <i class="ti ti-check-double me-2"></i>Publicar Noticia
                        </button>
                        <button type="button" class="btn btn-link text-muted fw-bold text-decoration-none shadow-none" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Colores y Estilos del Modal */
.bg-card { background: #ffffff; }
[data-bs-theme="dark"] .bg-card { background: #1a1d21; }

.modern-input-group {
    background: var(--bs-gray-100);
    border: 1px solid var(--bs-gray-200);
    border-radius: 12px;
    transition: all 0.2s ease;
}
[data-bs-theme="dark"] .modern-input-group {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}
.modern-input-group:focus-within {
    background: #fff;
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.1);
}
[data-bs-theme="dark"] .modern-input-group:focus-within { background: rgba(255, 255, 255, 0.08); }

.modern-input-group .form-control:focus { box-shadow: none; border: none; }
.modern-input-group .form-control { color: inherit; }

/* Zona de Carga Modernizada */
.news-drop-zone-modern {
    border: 2px dashed var(--bs-gray-300);
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--bs-gray-100);
    overflow: hidden;
}
[data-bs-theme="dark"] .news-drop-zone-modern {
    border-color: rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.03);
}
.news-drop-zone-modern:hover, .news-drop-zone-modern.dragover {
    border-color: var(--bs-primary);
    background: rgba(59, 130, 246, 0.05);
    transform: scale(1.01);
}

.upload-icon-wrapper {
    width: 64px;
    height: 64px;
    background: #fff;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
[data-bs-theme="dark"] .upload-icon-wrapper { background: rgba(255, 255, 255, 0.1); }

/* Cropper Modernizado */
.news-crop-zone-modern {
    border: 1px solid var(--bs-gray-200);
    border-radius: 16px;
    padding: 16px;
    background: #fff;
}
[data-bs-theme="dark"] .news-crop-zone-modern {
    background: rgba(255, 255, 255, 0.03);
    border-color: rgba(255, 255, 255, 0.1);
}

.news-crop-viewport-modern {
    position: relative;
    width: 100%;
    height: 220px;
    overflow: hidden;
    border-radius: 12px;
    background: #000;
}

.news-crop-frame {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: grab;
}
.news-crop-frame:active { cursor: grabbing; }

.news-crop-frame img {
    position: absolute;
    max-width: none;
    user-select: none;
    -webkit-user-drag: none;
}

.hover-lift { transition: transform 0.2s ease; }
.hover-lift:hover { transform: translateY(-3px); }
</style>

<script>
(function() {
    const dropZone = document.getElementById('news-drop-zone-modal');
    const cropZone = document.getElementById('news-crop-zone-modal');
    const fileInput = document.getElementById('news-file-input-modal');
    const preview = document.getElementById('news-preview-modal');
    const posXInput = document.getElementById('news-pos-x-modal');
    const posYInput = document.getElementById('news-pos-y-modal');
    const cropFrame = document.getElementById('news-crop-frame-modal');
    
    if (!dropZone || !cropFrame) return;

    let isDragging = false;
    let startX, startY, imgX = 0, imgY = 0;
    let imgWidth, imgHeight, frameWidth, frameHeight;

    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.onload = function() {
                    setupCropperModal();
                };
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    function setupCropperModal() {
        dropZone.classList.add('d-none');
        cropZone.classList.remove('d-none');
        
        frameWidth = cropFrame.offsetWidth;
        frameHeight = cropFrame.offsetHeight;
        
        const imgRatio = preview.naturalWidth / preview.naturalHeight;
        const frameRatio = frameWidth / frameHeight;
        
        if (imgRatio > frameRatio) {
            imgHeight = frameHeight;
            imgWidth = imgHeight * imgRatio;
        } else {
            imgWidth = frameWidth;
            imgHeight = imgWidth / imgRatio;
        }
        
        preview.style.width = imgWidth + 'px';
        preview.style.height = imgHeight + 'px';
        
        imgX = (frameWidth - imgWidth) / 2;
        imgY = (frameHeight - imgHeight) / 2;
        updatePositionModal();
    }

    function updatePositionModal() {
        preview.style.left = imgX + 'px';
        preview.style.top = imgY + 'px';
        
        const centerX = -imgX + frameWidth / 2;
        const centerY = -imgY + frameHeight / 2;
        posXInput.value = Math.max(0, Math.min(100, Math.round((centerX / imgWidth) * 100)));
        posYInput.value = Math.max(0, Math.min(100, Math.round((centerY / imgHeight) * 100)));
    }

    cropFrame.addEventListener('mousedown', function(e) {
        isDragging = true;
        startX = e.clientX - imgX;
        startY = e.clientY - imgY;
        e.preventDefault();
    });

    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        
        const minX = frameWidth - imgWidth;
        const minY = frameHeight - imgHeight;
        
        imgX = Math.max(minX, Math.min(0, e.clientX - startX));
        imgY = Math.max(minY, Math.min(0, e.clientY - startY));
        
        updatePositionModal();
    });

    document.addEventListener('mouseup', function() {
        isDragging = false;
    });

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
    });

    dropZone.addEventListener('drop', e => {
        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            fileInput.dispatchEvent(new Event('change'));
        }
    }, false);

    window.resetNewsImageModal = function() {
        fileInput.value = '';
        preview.src = '';
        cropZone.classList.add('d-none');
        dropZone.classList.remove('d-none');
        posXInput.value = 50;
        posYInput.value = 50;
        imgX = 0;
        imgY = 0;
    };
})();
</script>
