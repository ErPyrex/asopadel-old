{% extends 'base.html' %}
{% load static %}
{% block title %}
  {% if noticia %}
    Editar Noticia
  {% else %}
    Crear Noticia
  {% endif %}
{% endblock %}
{% block back_url %}
  <a href="{% url 'core:admin_noticias_list' %}"
     class="btn-back-custom"
     aria-label="Volver">
    <i class="ti ti-chevron-left"></i>
  </a>
{% endblock %}
{% block content %}
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
          <div class="card-header bg-primary py-4 text-center">
            <h2 class="h3 fw-bold mb-0 text-white">
              <i class="ti {% if noticia %}ti-edit{% else %}ti-news{% endif %} me-2"></i>
              {% if noticia %}
                Editar
              {% else %}
                Publicar
              {% endif %}
              Noticia
            </h2>
          </div>
          <div class="card-body p-4 p-md-5">
            <form method="POST" enctype="multipart/form-data" class="modern-form">
              {% csrf_token %}
              {% for field in form %}
                <div class="mb-4">
                  <label for="{{ field.id_for_label }}"
                         class="form-label fw-bold text-muted small text-uppercase mb-2">{{ field.label }}</label>
                  {% if field.name == 'imagen' %}
                    <div class="image-upload-wrapper">
                      <div id="drop-zone"
                           class="image-drop-zone {% if noticia.imagen %}has-image{% endif %}"
                           onclick="document.getElementById('{{ field.id_for_label }}').click()">
                        <input type="file"
                               name="{{ field.name }}"
                               id="{{ field.id_for_label }}"
                               class="d-none"
                               accept="image/*"
                               onchange="previewImage(this)">
                        <div id="drop-zone-content" class="text-center p-4">
                          <div class="upload-icon mb-3">
                            <i class="ti ti-cloud-upload fs-1 text-primary"></i>
                          </div>
                          <div class="upload-text">
                            <p class="fw-bold mb-1">Arrastra una imagen aquí</p>
                            <p class="text-muted small mb-0">
                              o haz clic para seleccionar una de tus
                              archivos
                            </p>
                          </div>
                        </div>
                        <div id="image-preview-container"
                             class="image-preview-overlay {% if not noticia.imagen %}d-none{% endif %}">
                          <img id="image-preview"
                               src="{% if noticia.imagen %}{{ noticia.imagen.url }}{% endif %}"
                               alt="Vista previa">
                          <div class="preview-actions">
                            <button type="button"
                                    class="btn btn-light btn-sm rounded-pill shadow-sm"
                                    onclick="event.stopPropagation(); document.getElementById('{{ field.id_for_label }}').click()">
                              <i class="ti ti-refresh me-1"></i>Cambiar
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% elif field.name == 'cuerpo' %}
                    <div class="input-group">
                      <span class="input-group-text bg-light border-end-0 align-items-start pt-2"><i class="ti ti-align-left"></i></span>
                      <textarea name="{{ field.name }}"
                                id="{{ field.id_for_label }}"
                                rows="8"
                                class="form-control bg-light border-start-0"
                                placeholder="Escribe el contenido aquí...">{{ field.value|default:"" }}</textarea>
                    </div>
                  {% else %}
                    <div class="input-group">
                      <span class="input-group-text bg-light border-end-0"><i class="ti ti-type"></i></span>
                      <input type="text"
                             name="{{ field.name }}"
                             id="{{ field.id_for_label }}"
                             class="form-control bg-light border-start-0"
                             value="{{ field.value|default:"" }}"
                             placeholder="Título de la noticia">
                    </div>
                  {% endif %}
                  {% if field.errors %}
                    <div class="text-danger small mt-1">
                      {% for error in field.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
              <div class="d-grid gap-3 mt-5">
                <button type="submit"
                        class="btn btn-primary btn-lg rounded-pill fw-bold shadow">
                  <i class="ti ti-device-floppy me-2"></i>
                  {% if noticia %}
                    Guardar Cambios
                  {% else
                    %}
                    Publicar Noticia
                  {% endif %}
                </button>
                <a href="{% url 'core:admin_noticias_list' %}"
                   class="btn btn-light btn-lg rounded-pill fw-bold text-muted">Cancelar</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  </style>
  <script>
    function previewImage(input) {
        const preview = document.getElementById('image-preview');
        const container = document.getElementById('image-preview-container');
        const dropZone = document.getElementById('drop-zone');

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.src = e.target.result;
                container.classList.remove('d-none');
                dropZone.classList.add('has-image');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Lógica de Drag & Drop
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.querySelector('input[type="file"]');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
    });

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        previewImage(fileInput);
    }
  </script>
  <style>
    .image-drop-zone {
        border: 2px dashed var(--color-border);
        border-radius: 16px;
        background-color: var(--bg-light);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .image-drop-zone:hover,
    .image-drop-zone.drag-over {
        border-color: var(--color-primary);
        background-color: rgba(var(--color-primary-rgb), 0.05);
    }

    .image-drop-zone.has-image {
        border-style: solid;
        border-color: var(--color-primary);
    }

    .image-preview-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000;
        z-index: 5;
    }

    .image-preview-overlay img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .preview-actions {
        position: absolute;
        bottom: 15px;
        left: 0;
        right: 0;
        z-index: 10;
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    .upload-icon i {
        transition: transform 0.3s ease;
    }

    .image-drop-zone:hover .upload-icon i {
        transform: translateY(-5px);
    }

    .modern-form .input-group-text {
        border-radius: 12px 0 0 12px;
        color: var(--color-primary);
    }

    .modern-form .form-control {
        border-radius: 0 12px 12px 0;
        padding: 0.75rem 1rem;
        border: 1px solid #eee;
    }

    .modern-form .form-control:focus {
        background-color: #fff;
        border-color: var(--color-primary);
        box-shadow: none;
    }

    .modern-form textarea.form-control {
        border-radius: 0 12px 12px 12px;
    }
  </style>
{% endblock %}
